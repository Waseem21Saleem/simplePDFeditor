<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Simple PDF Editor</title>
    
    <link rel="manifest" id="manifest-link">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --bg: #121212; --surface: #1e1e1e; --primary: #0a84ff; 
            --text: #ffffff; --border: #333; --danger: #ff453a;
        }
        
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden; }

        /* Touch-Friendly Buttons */
        button { background: transparent; color: var(--text); border: 1px solid transparent; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; transition: 0.2s; padding: 8px; min-width: 50px; min-height: 44px; white-space: nowrap; }
        button:active { background: rgba(255,255,255,0.1); }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        button.active { background: rgba(10, 132, 255, 0.2); color: var(--primary); border-color: var(--primary); }
        button.primary-btn { background: var(--primary); color: white; border: none; padding: 10px 16px; flex-direction: row; gap: 8px; }
        
        input[type="color"] { width: 34px; height: 34px; padding: 0; border: none; border-radius: 6px; background: none; }
        select { background: #333; color: white; border: none; border-radius: 6px; padding: 8px; font-size: 14px; min-height: 44px; }

        /* Top Bar */
        .top-bar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; z-index: 100; flex-shrink: 0; }
        .page-controls { display: flex; align-items: center; gap: 10px; background: #000; padding: 4px 8px; border-radius: 20px; }
        .page-controls button { min-height: 36px; min-width: 36px; padding: 0; }

        /* Workspace & Scrolling */
        #workspace { flex: 1; overflow: auto; background: var(--bg); position: relative; -webkit-overflow-scrolling: touch; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        #canvas-wrapper { background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.5); transform-origin: top left; }

        /* Bottom Toolbar (Mobile First) */
        .bottom-bar { background: var(--surface); border-top: 1px solid var(--border); padding: 10px; display: flex; gap: 8px; overflow-x: auto; z-index: 100; flex-shrink: 0; align-items: center; scrollbar-width: none; }
        .bottom-bar::-webkit-scrollbar { display: none; }
        
        .divider { width: 1px; height: 30px; background: var(--border); margin: 0 5px; flex-shrink: 0; }

        /* Sub-toolbar for properties */
        .properties-bar { background: #2a2a2a; padding: 8px 15px; display: none; gap: 15px; align-items: center; overflow-x: auto; flex-shrink: 0; }

        /* Overlays */
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal { background: var(--surface); border-radius: 12px; padding: 20px; width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 15px; }
        .modal h3 { margin: 0; font-size: 18px; }
        .modal input[type="text"] { background: #000; color: white; border: 1px solid var(--border); padding: 12px; border-radius: 8px; font-size: 16px; width: 100%; }
        
        #sig-container { border: 2px dashed #555; background: white; border-radius: 8px; touch-action: none; overflow: hidden; }

        #loader { display: none; flex-direction: column; align-items: center; gap: 15px; z-index: 2000; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="top-bar">
    <div style="display: flex; gap: 10px;">
        <input type="file" id="upload-pdf" accept="application/pdf" hidden>
        <button class="primary-btn" onclick="document.getElementById('upload-pdf').click()">
            <span style="font-size: 18px;">üìÑ</span> Open
        </button>
    </div>

    <div class="page-controls">
        <button onclick="changePage(-1)" id="prev-btn" disabled>‚óÄ</button>
        <span id="page-info" style="font-size: 14px; font-weight: bold; min-width: 40px; text-align: center;">0/0</span>
        <button onclick="changePage(1)" id="next-btn" disabled>‚ñ∂</button>
    </div>

    <button class="primary-btn" style="background: #30d158;" onclick="openExportModal()">
        <span style="font-size: 18px;">üíæ</span> Save
    </button>
</div>

<div class="properties-bar" id="prop-bar">
    <input type="color" id="colorPicker" value="#000000" onchange="updateStyle()">
    <select id="sizePicker" onchange="updateStyle()">
        <option value="14">Small</option>
        <option value="22" selected>Medium</option>
        <option value="36">Large</option>
        <option value="60">Extra Large</option>
    </select>
    <button onclick="deleteSelected()" style="color: var(--danger); font-size: 20px; margin-left: auto;">üóëÔ∏è</button>
</div>

<div id="workspace">
    <div id="canvas-wrapper">
        <canvas id="main-canvas"></canvas>
    </div>
</div>

<div class="bottom-bar">
    <button id="tool-pan" onclick="setTool('pan')" class="active" style="font-size: 20px;">üñêÔ∏è<span style="font-size: 10px;">Pan</span></button>
    <div class="divider"></div>
    <button id="tool-text" onclick="setTool('text')" style="font-size: 20px;">üìù<span style="font-size: 10px;">Text</span></button>
    <button id="tool-pen" onclick="setTool('pen')" style="font-size: 20px;">üñäÔ∏è<span style="font-size: 10px;">Pen</span></button>
    <button id="tool-highlighter" onclick="setTool('highlighter')" style="font-size: 20px;">üñçÔ∏è<span style="font-size: 10px;">Highlight</span></button>
    <div class="divider"></div>
    <button onclick="openSignatureModal()" style="font-size: 20px;">üñãÔ∏è<span style="font-size: 10px;">Sign</span></button>
    <input type="file" id="upload-img" accept="image/*" hidden onchange="handleImageUpload(event)">
    <button onclick="document.getElementById('upload-img').click()" style="font-size: 20px;">üñºÔ∏è<span style="font-size: 10px;">Image</span></button>
    <div class="divider"></div>
    <button onclick="setZoom(0.2)" style="font-size: 20px;">üîç+<span style="font-size: 10px;">Zoom In</span></button>
    <button onclick="setZoom(-0.2)" style="font-size: 20px;">üîç-<span style="font-size: 10px;">Zoom Out</span></button>
</div>

<div class="overlay" id="loader-overlay"><div id="loader"><div class="spinner"></div><div id="loader-text">Loading...</div></div></div>

<div class="overlay" id="sig-modal">
    <div class="modal">
        <h3>Sign Document</h3>
        <div id="sig-container"><canvas id="sig-canvas" width="300" height="150"></canvas></div>
        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
            <button onclick="clearSignature()" style="color: #aaa;">Clear</button>
            <div style="display: flex; gap: 10px;">
                <button onclick="closeModal('sig-modal')">Cancel</button>
                <button class="primary-btn" onclick="saveSignature()">Insert</button>
            </div>
        </div>
    </div>
</div>

<div class="overlay" id="export-modal">
    <div class="modal">
        <h3>Save Document</h3>
        <input type="text" id="export-name" value="Edited_Document">
        <select id="export-format" style="width: 100%; margin-top: 10px;">
            <option value="pdf">Save as PDF</option>
            <option value="png">Save Page as Image</option>
        </select>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
            <button onclick="closeModal('export-modal')">Cancel</button>
            <button class="primary-btn" onclick="executeExport()">Download</button>
        </div>
    </div>
</div>

<script>
    // --- PWA Setup (Single File Trick) ---
    const manifest = {
        name: "Simple PDF Editor", short_name: "PDF Edit", start_url: ".", display: "standalone",
        background_color: "#121212", theme_color: "#1e1e1e",
        icons: [{ src: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230a84ff'/><path d='M30 25h40v50H30z' fill='white'/><path d='M40 40h20m-20 10h20m-20 10h10' stroke='%230a84ff' stroke-width='4' stroke-linecap='round'/></svg>", sizes: "192x192", type: "image/svg+xml" }]
    };
    document.getElementById('manifest-link').href = 'data:application/manifest+json;charset=utf-8,' + encodeURIComponent(JSON.stringify(manifest));

    const swCode = `self.addEventListener('fetch', e => {});`;
    navigator.serviceWorker?.register(URL.createObjectURL(new Blob([swCode], { type: 'application/javascript' })));

    // --- Core Setup ---
    const { jsPDF } = window.jspdf;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let canvas = new fabric.Canvas('main-canvas', { preserveObjectStacking: true, selection: false });
    let sigCanvas; 
    let pdfDoc = null, pageNum = 1, currentZoom = 1;
    let pageStates = {};
    let activeTool = 'pan'; // pan, text, pen, highlighter

    // --- Tool Switching ---
    function setTool(tool) {
        activeTool = tool;
        document.querySelectorAll('.bottom-bar button').forEach(b => b.classList.remove('active'));
        document.getElementById('tool-' + tool)?.classList.add('active');
        
        canvas.isDrawingMode = (tool === 'pen' || tool === 'highlighter');
        canvas.selection = (tool !== 'pan');
        
        if (tool === 'pan') {
            canvas.defaultCursor = 'grab';
            document.getElementById('prop-bar').style.display = 'none';
        } else {
            canvas.defaultCursor = tool === 'text' ? 'crosshair' : 'default';
            document.getElementById('prop-bar').style.display = 'flex';
            updateStyle();
        }
    }

    // --- Canvas Panning Logic (For mobile scrolling) ---
    let isDragging = false, lastPosX, lastPosY;
    canvas.on('mouse:down', function(opt) {
        if (activeTool === 'pan') {
            isDragging = true;
            canvas.defaultCursor = 'grabbing';
            lastPosX = opt.e.clientX || opt.e.touches?.[0].clientX;
            lastPosY = opt.e.clientY || opt.e.touches?.[0].clientY;
        } else if (activeTool === 'text' && !opt.target) {
            // Text Placement Fallback for Mobile
            let textValue = prompt("Enter text to insert:");
            if (textValue) {
                let pointer = canvas.getPointer(opt.e);
                let textObj = new fabric.IText(textValue, {
                    left: pointer.x, top: pointer.y,
                    fill: document.getElementById('colorPicker').value,
                    fontSize: parseInt(document.getElementById('sizePicker').value)
                });
                canvas.add(textObj);
                canvas.setActiveObject(textObj);
                setTool('pan'); // auto switch back to pan
            }
        }
    });

    canvas.on('mouse:move', function(opt) {
        if (isDragging && activeTool === 'pan') {
            let e = opt.e;
            let clientX = e.clientX || e.touches?.[0].clientX;
            let clientY = e.clientY || e.touches?.[0].clientY;
            let workspace = document.getElementById('workspace');
            workspace.scrollLeft -= (clientX - lastPosX);
            workspace.scrollTop -= (clientY - lastPosY);
            lastPosX = clientX; lastPosY = clientY;
        }
    });

    canvas.on('mouse:up', () => { isDragging = false; if(activeTool === 'pan') canvas.defaultCursor = 'grab'; });

    // Double tap text to edit safely on mobile
    let lastTap = 0;
    canvas.on('mouse:down', function(opt) {
        let currentTime = new Date().getTime();
        let tapLength = currentTime - lastTap;
        if (tapLength < 500 && tapLength > 0 && opt.target && opt.target.type === 'i-text') {
            let newText = prompt("Edit your text:", opt.target.text);
            if(newText !== null) { opt.target.set('text', newText); canvas.renderAll(); }
        }
        lastTap = currentTime;
    });

    canvas.on('selection:created', () => document.getElementById('prop-bar').style.display = 'flex');
    canvas.on('selection:cleared', () => { if(activeTool === 'pan') document.getElementById('prop-bar').style.display = 'none'; });

    // --- Document Loading & Auto-Fit ---
    document.getElementById('upload-pdf').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        showLoader('Loading...');
        const typedarray = new Uint8Array(await file.arrayBuffer());
        pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
        pageNum = 1; pageStates = {}; 
        await renderPage(pageNum, true);
        hideLoader();
    });

    async function renderPage(num, autoFit = false) {
        const page = await pdfDoc.getPage(num);
        const baseViewport = page.getViewport({ scale: 2.0 }); // High res render
        
        // Auto-fit to screen width on first load
        if (autoFit) {
            let screenWidth = window.innerWidth - 40; // minus padding
            currentZoom = screenWidth / baseViewport.width;
            updateZoomDisplay();
        }

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = baseViewport.width; tempCanvas.height = baseViewport.height;
        await page.render({ canvasContext: tempCanvas.getContext('2d'), viewport: baseViewport }).promise;

        canvas.clear();
        canvas.setDimensions({ width: baseViewport.width, height: baseViewport.height });

        fabric.Image.fromURL(tempCanvas.toDataURL(), (img) => {
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
            if (pageStates[num]) canvas.loadFromJSON(pageStates[num], canvas.renderAll.bind(canvas));
        });

        document.getElementById('page-info').textContent = `${num}/${pdfDoc.numPages}`;
        document.getElementById('prev-btn').disabled = num <= 1;
        document.getElementById('next-btn').disabled = num >= pdfDoc.numPages;
    }

    function changePage(offset) {
        if (!pdfDoc) return;
        let newPage = pageNum + offset;
        if (newPage > 0 && newPage <= pdfDoc.numPages) {
            pageStates[pageNum] = JSON.stringify(canvas);
            pageNum = newPage;
            renderPage(pageNum);
        }
    }

    // --- Zoom Math ---
    function updateZoomDisplay() {
        document.getElementById('canvas-wrapper').style.transform = `scale(${currentZoom})`;
        canvas.calcOffset();
    }
    function setZoom(change) {
        currentZoom = Math.max(0.2, Math.min(4, currentZoom + change));
        updateZoomDisplay();
    }

    // Smart Center Insert
    function getCenter() {
        let ws = document.getElementById('workspace');
        let rect = document.getElementById('canvas-wrapper').getBoundingClientRect();
        return {
            left: Math.max(50, (ws.clientWidth/2 - rect.left) / currentZoom),
            top: Math.max(50, (ws.clientHeight/2 - rect.top) / currentZoom)
        };
    }

    // --- Styling & Deleting ---
    function updateStyle() {
        let color = document.getElementById('colorPicker').value;
        let size = parseInt(document.getElementById('sizePicker').value);
        let active = canvas.getActiveObject();
        
        if (active && active.type === 'i-text') { active.set({fill: color, fontSize: size}); canvas.renderAll(); }
        
        if (activeTool === 'highlighter') {
            let r = parseInt(color.substr(1,2),16), g = parseInt(color.substr(3,2),16), b = parseInt(color.substr(5,2),16);
            canvas.freeDrawingBrush.color = `rgba(${r},${g},${b}, 0.3)`;
            canvas.freeDrawingBrush.width = size * 1.5;
        } else {
            canvas.freeDrawingBrush.color = color;
            canvas.freeDrawingBrush.width = size / 4;
        }
    }

    canvas.on('path:created', function(opt) {
        if (activeTool === 'highlighter') { opt.path.globalCompositeOperation = 'multiply'; canvas.renderAll(); }
    });

    function deleteSelected() {
        let active = canvas.getActiveObjects();
        if (active.length) { canvas.discardActiveObject(); active.forEach(obj => canvas.remove(obj)); }
    }

    // --- Image & Signature ---
    function handleImageUpload(e) {
        let file = e.target.files[0];
        if(!file) return;
        let reader = new FileReader();
        reader.onload = function(f) {
            fabric.Image.fromURL(f.target.result, (img) => {
                let center = getCenter();
                img.scaleToWidth(150); img.set({left: center.left, top: center.top, originX: 'center', originY: 'center'});
                canvas.add(img); canvas.setActiveObject(img); setTool('pan');
            });
        };
        reader.readAsDataURL(file); e.target.value = "";
    }

    function openSignatureModal() {
        document.getElementById('sig-modal').style.display = 'flex';
        if(!sigCanvas) {
            sigCanvas = new fabric.Canvas('sig-canvas', { isDrawingMode: true });
            sigCanvas.freeDrawingBrush.width = 3;
            // Prevent scrolling while signing
            document.getElementById('sig-container').addEventListener('touchmove', e => e.preventDefault(), {passive: false});
        }
        sigCanvas.clear();
    }
    function clearSignature() { if(sigCanvas) sigCanvas.clear(); }
    function saveSignature() {
        if(sigCanvas.getObjects().length === 0) return closeModal('sig-modal');
        fabric.Image.fromURL(sigCanvas.toDataURL('image/png'), (img) => {
            let center = getCenter();
            img.set({left: center.left, top: center.top, originX: 'center', originY: 'center'});
            canvas.add(img); canvas.setActiveObject(img); setTool('pan');
            closeModal('sig-modal');
        });
    }

    // --- Safe Mobile Exporting ---
    function openExportModal() { if(pdfDoc) document.getElementById('export-modal').style.display = 'flex'; else alert("Open a PDF first!"); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showLoader(text) { document.getElementById('loader-overlay').style.display='flex'; document.getElementById('loader').style.display='flex'; document.getElementById('loader-text').innerText=text; }
    function hideLoader() { document.getElementById('loader-overlay').style.display='none'; }

    async function executeExport() {
        closeModal('export-modal');
        showLoader('Saving file...');
        let name = document.getElementById('export-name').value || 'Edited_Document';
        let format = document.getElementById('export-format').value;

        setTimeout(async () => {
            if (format === 'png') {
                let a = document.createElement('a');
                a.href = canvas.toDataURL({format: 'png', quality: 1});
                a.download = name + '.png'; a.click();
            } else {
                pageStates[pageNum] = JSON.stringify(canvas);
                let newPdf = null;
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 2.0 });
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.height = viewport.height; tempCanvas.width = viewport.width;
                    await page.render({ canvasContext: tempCanvas.getContext('2d'), viewport: viewport }).promise;

                    const staticCanvas = new fabric.StaticCanvas(null, { width: viewport.width, height: viewport.height });
                    await new Promise(r => fabric.Image.fromURL(tempCanvas.toDataURL(), img => {
                        staticCanvas.setBackgroundImage(img, () => {
                            if (pageStates[i]) staticCanvas.loadFromJSON(pageStates[i], () => { staticCanvas.renderAll(); r(); });
                            else r();
                        });
                    }));

                    let imgData = staticCanvas.toDataURL('image/jpeg', 0.8); // 0.8 saves RAM on mobile
                    let orient = viewport.width > viewport.height ? 'l' : 'p';
                    if (i === 1) newPdf = new jsPDF({ orientation: orient, unit: 'px', format: [viewport.width, viewport.height] });
                    else newPdf.addPage([viewport.width, viewport.height], orient);
                    newPdf.addImage(imgData, 'JPEG', 0, 0, viewport.width, viewport.height);
                }
                
                // Safe Blob Download for iOS and Android compatibility
                let blob = newPdf.output('blob');
                let url = URL.createObjectURL(blob);
                let a = document.createElement('a');
                a.href = url; a.download = name + '.pdf';
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 500);
            }
            hideLoader();
        }, 50);
    }
</script>
</body>
</html>
